<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Campaign Control Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#060b17;--surface:#0d1526;--surface2:#131e30;--surface3:#18263d;
  --border:#1d2e48;--border2:#243552;
  --accent:#f97316;--accent2:#fb923c;--accentglow:rgba(249,115,22,.15);
  --blue:#3b82f6;--cyan:#06b6d4;--purple:#8b5cf6;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
  --text:#e2e8f0;--text2:#94a3b8;--muted:#475569;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(ellipse 60% 40% at 0% 0%,rgba(249,115,22,.06) 0%,transparent 60%),
  radial-gradient(ellipse 50% 60% at 100% 100%,rgba(59,130,246,.05) 0%,transparent 60%),
  radial-gradient(ellipse 40% 30% at 50% 50%,rgba(139,92,246,.03) 0%,transparent 60%);
  pointer-events:none;z-index:0}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:230px;background:rgba(13,21,38,.95);
  border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:50;
  transition:transform .3s;backdrop-filter:blur(10px)}
.sb-logo{padding:22px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sb-logomark{width:40px;height:40px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),#c2410c);
  display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff;
  box-shadow:0 4px 16px rgba(249,115,22,.35);flex-shrink:0}
.sb-title{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;letter-spacing:.3px}
.sb-sub{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-top:1px}
.sb-section{padding:10px 12px 4px;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600}
.nav{padding:8px 10px;flex:1;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;
  cursor:pointer;font-size:13.5px;font-weight:500;transition:all .18s;margin-bottom:2px;color:var(--text2);
  position:relative}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:linear-gradient(135deg,rgba(249,115,22,.18),rgba(249,115,22,.08));
  color:var(--accent);border:1px solid rgba(249,115,22,.2)}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);
  width:3px;height:60%;background:var(--accent);border-radius:0 3px 3px 0}
.nav-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.sb-footer{padding:14px;border-top:1px solid var(--border)}
.sb-user{display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px}
.sb-avatar{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--purple));
  display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.sb-uname{font-size:13px;font-weight:600}
.sb-urole{font-size:11px;color:var(--muted)}

/* â”€â”€ MAIN â”€â”€ */
.main{margin-left:230px;min-height:100vh;position:relative;z-index:1}
.topbar{background:rgba(13,21,38,.8);border-bottom:1px solid var(--border);
  padding:0 28px;height:60px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:40;backdrop-filter:blur(12px)}
.topbar-left{display:flex;align-items:center;gap:14px}
.page-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px}
.breadcrumb{font-size:12px;color:var(--muted)}
.topbar-right{display:flex;align-items:center;gap:10px}
.topbar-date{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:5px 12px}
.hamburger{display:none;align-items:center;justify-content:center;width:34px;height:34px;
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:17px}
.content{padding:28px}

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:20px;position:relative;overflow:hidden;transition:all .2s;cursor:default}
.stat-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3)}
.stat-card::after{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;
  border-radius:50%;opacity:.08}
.stat-card.c-orange::after{background:var(--accent)}
.stat-card.c-blue::after{background:var(--blue)}
.stat-card.c-green::after{background:var(--success)}
.stat-card.c-purple::after{background:var(--purple)}
.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:18px;margin-bottom:14px}
.stat-card.c-orange .stat-icon{background:rgba(249,115,22,.15)}
.stat-card.c-blue .stat-icon{background:rgba(59,130,246,.15)}
.stat-card.c-green .stat-icon{background:rgba(16,185,129,.15)}
.stat-card.c-purple .stat-icon{background:rgba(139,92,246,.15)}
.stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:6px}
.stat-value{font-family:'Syne',sans-serif;font-weight:800;font-size:32px;line-height:1}
.stat-card.c-orange .stat-value{color:var(--accent)}
.stat-card.c-blue .stat-value{color:var(--blue)}
.stat-card.c-green .stat-value{color:var(--success)}
.stat-card.c-purple .stat-value{color:var(--purple)}
.stat-sub{font-size:12px;color:var(--muted);margin-top:6px}
.stat-trend{position:absolute;bottom:16px;right:16px;font-size:11px;font-weight:600;
  padding:3px 8px;border-radius:20px}
.trend-up{background:rgba(16,185,129,.15);color:var(--success)}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;
  transition:border-color .2s;margin-bottom:20px}
.card:hover{border-color:var(--border2)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}

/* â”€â”€ CAMPAIGN ROWS â”€â”€ */
.camp-row{display:flex;align-items:flex-start;gap:12px;background:var(--surface2);
  border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;transition:all .2s}
.camp-row:hover{border-color:rgba(249,115,22,.3);background:var(--surface3)}
.camp-name{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;margin-bottom:4px}
.camp-meta{font-size:12px;color:var(--text2);line-height:1.7}

/* â”€â”€ FORMS â”€â”€ */
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;color:var(--text2);margin-bottom:7px;font-weight:600;
  text-transform:uppercase;letter-spacing:.8px}
input[type=text],input[type=date],select,textarea{width:100%;background:var(--surface2);
  border:1px solid var(--border);border-radius:10px;color:var(--text);padding:11px 14px;
  font-family:'DM Sans',sans-serif;font-size:14px;outline:none;
  transition:border-color .2s,box-shadow .2s;appearance:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accentglow)}
select option{background:var(--surface2)}
textarea{resize:vertical;min-height:60px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:10px 18px;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-weight:700;
  font-size:13px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--accent),#c2410c);color:#fff;box-shadow:0 2px 8px rgba(249,115,22,.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(249,115,22,.35)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
.btn-success:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(16,185,129,.3)}
.btn-danger{background:rgba(239,68,68,.1);color:var(--danger);border:1px solid rgba(239,68,68,.25)}
.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-sm{padding:5px 11px;font-size:11px;border-radius:7px}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap}
.badge-active{background:rgba(16,185,129,.12);color:var(--success);border:1px solid rgba(16,185,129,.2)}
.badge-inactive{background:rgba(100,116,139,.12);color:var(--muted);border:1px solid rgba(100,116,139,.2)}

/* â”€â”€ PARAM BUILDER â”€â”€ */
.param-block{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.param-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.param-header input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:8px 12px;font-size:13px;outline:none;font-family:'DM Sans',sans-serif}
.param-header input:focus{border-color:var(--accent)}
.col-pills{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.col-pill{display:inline-flex;align-items:center;gap:4px;background:rgba(249,115,22,.1);
  border:1px solid rgba(249,115,22,.2);color:var(--accent);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:600}
.col-pill button{background:none;border:none;cursor:pointer;color:var(--accent);font-size:14px;line-height:1;padding:0 1px}
.col-add-row{display:flex;gap:6px}
.col-add-row input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:7px 10px;font-size:13px;outline:none;font-family:'DM Sans',sans-serif}
.col-add-row input:focus{border-color:var(--accent)}

/* â”€â”€ TABLE â”€â”€ */
.table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
thead{background:var(--surface2)}
th{padding:11px 13px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1px;
  color:var(--text2);font-weight:600;white-space:nowrap;border-bottom:1px solid var(--border)}
td{padding:10px 13px;border-top:1px solid var(--border);white-space:nowrap;color:var(--text)}
tr:hover td{background:rgba(249,115,22,.03)}
tfoot td{background:var(--surface2);font-weight:700;font-family:'Syne',sans-serif;
  border-top:2px solid var(--border);color:var(--accent)}

/* â”€â”€ BRANCH ACTIVITY GRID â”€â”€ */
.branch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px}
.branch-tile{background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:10px 13px;display:flex;align-items:center;gap:10px;font-size:12.5px;transition:all .15s}
.branch-tile:hover{border-color:var(--border2)}
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:all .3s}
.dot-green{background:var(--success);box-shadow:0 0 8px rgba(16,185,129,.6)}
.dot-red{background:var(--danger);box-shadow:0 0 6px rgba(239,68,68,.4)}

/* â”€â”€ EXPORT BAR â”€â”€ */
.export-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.export-bar .lbl{font-size:12px;color:var(--text2);font-weight:600;margin-right:4px}

/* â”€â”€ BANNER MANAGER â”€â”€ */
.banner-preview{width:100%;height:140px;object-fit:cover;border-radius:10px;display:block;border:1px solid var(--border)}
.banner-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;position:relative;transition:all .2s}
.banner-card:hover{border-color:rgba(249,115,22,.3)}
.banner-card .del-btn{position:absolute;top:8px;right:8px;background:rgba(239,68,68,.85);
  border:none;border-radius:6px;color:#fff;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:700}
.banner-info{padding:10px 12px}
.banner-caption{font-size:12px;color:var(--text2);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:32px 20px;text-align:center;
  cursor:pointer;transition:all .2s;color:var(--muted)}
.upload-zone:hover{border-color:var(--accent);color:var(--accent);background:var(--accentglow)}
.upload-zone input{display:none}

/* â”€â”€ ACTIVITY TIMELINE â”€â”€ */
.timeline{display:flex;flex-direction:column;gap:10px}
.tl-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface2);
  border:1px solid var(--border);border-radius:10px}
.tl-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0}
.tl-name{font-size:13px;font-weight:500;flex:1}
.tl-time{font-size:11px;color:var(--muted)}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(6,11,23,.9);z-index:200;
  display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:20px;
  padding:28px;width:92%;max-width:600px;max-height:90vh;overflow-y:auto;
  box-shadow:0 32px 80px rgba(0,0,0,.7)}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:19px;margin-bottom:22px;
  display:flex;align-items:center;gap:10px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:22px;padding-top:18px;
  border-top:1px solid var(--border)}
.divider{border:none;border-top:1px solid var(--border);margin:18px 0}

/* â”€â”€ OVERLAY / TOAST â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(6,11,23,.9);display:none;
  align-items:center;justify-content:center;z-index:500;flex-direction:column;gap:16px}
.overlay.show{display:flex}
.spinner{width:42px;height:42px;border:3px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;transform:translateX(220px);background:var(--surface);
  border:1px solid var(--border2);border-radius:13px;padding:14px 20px;font-size:13.5px;z-index:1000;
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:10px;
  box-shadow:0 10px 40px rgba(0,0,0,.5);max-width:380px}
.toast.show{transform:translateX(0)}
.toast.success{border-color:var(--success)}.toast.error{border-color:var(--danger)}.toast.warning{border-color:var(--warning)}

.warn-box{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:12px;
  padding:14px 18px;margin-bottom:20px;font-size:13px;color:var(--warning);line-height:1.8}
.info-box{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:12px;
  padding:14px 18px;margin-bottom:20px;font-size:13px;color:#93c5fd;line-height:1.8}
.ok-box{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);border-radius:12px;
  padding:12px 18px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px}

.progress-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;border-radius:2px;transition:width .5s ease;background:linear-gradient(90deg,var(--accent),var(--accent2))}

@media(max-width:900px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}
  .main{margin-left:0}.grid-2{grid-template-columns:1fr}.hamburger{display:flex}.content{padding:16px}
  .stats-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sb-logo">
    <div class="sb-logomark">C</div>
    <div><div class="sb-title">CampaignCtrl</div><div class="sb-sub">Admin Panel</div></div>
  </div>
  <nav class="nav">
    <div class="sb-section">Main</div>
    <div class="nav-item active" onclick="showPage('dashboard')"  id="nav-dashboard"><span class="nav-icon">ğŸ“Š</span>Dashboard</div>
    <div class="nav-item"        onclick="showPage('campaigns')"  id="nav-campaigns"><span class="nav-icon">ğŸ¯</span>Campaigns</div>
    <div class="nav-item"        onclick="showPage('banners')"    id="nav-banners"  ><span class="nav-icon">ğŸ–¼ï¸</span>Banner Images</div>
    <div class="sb-section">Data</div>
    <div class="nav-item"        onclick="showPage('reports')"    id="nav-reports"  ><span class="nav-icon">ğŸ“ˆ</span>Reports</div>
    <div class="nav-item"        onclick="showPage('branches')"   id="nav-branches" ><span class="nav-icon">ğŸ¢</span>Branch Activity</div>
    <div class="sb-section">System</div>
    <div class="nav-item"        onclick="showPage('settings')"   id="nav-settings" ><span class="nav-icon">âš™ï¸</span>Settings</div>
  </nav>
  <div class="sb-footer">
    <div class="sb-user">
      <div class="sb-avatar">A</div>
      <div><div class="sb-uname">Administrator</div><div class="sb-urole">Full Access</div></div>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
      <div>
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="breadcrumb" id="pageBread">Overview & Statistics</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="topbar-date" id="topDate"></div>
      <button class="btn btn-secondary btn-sm" onclick="loadAdminData()">â†º Refresh</button>
    </div>
  </div>

  <div class="content">

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <div id="page-dashboard">
      <div id="configAlert"></div>

      <div class="stats-grid">
        <div class="stat-card c-orange">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-label">Active Campaigns</div>
          <div class="stat-value" id="s-camps">â€”</div>
          <div class="stat-sub">running today</div>
        </div>
        <div class="stat-card c-green">
          <div class="stat-icon">ğŸ¢</div>
          <div class="stat-label">Branches Active</div>
          <div class="stat-value" id="s-branches">â€”</div>
          <div class="stat-sub" id="s-brSub">visited portal today</div>
          <div class="progress-bar"><div class="progress-fill" id="s-brProg" style="width:0%"></div></div>
        </div>
        <div class="stat-card c-blue">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-label">Reports Today</div>
          <div class="stat-value" id="s-reports">â€”</div>
          <div class="stat-sub">submissions received</div>
        </div>
        <div class="stat-card c-purple">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-label">Total Campaigns</div>
          <div class="stat-value" id="s-total">â€”</div>
          <div class="stat-sub">all time</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ¯ Active Campaigns Today</div>
            <button class="btn btn-primary btn-sm" onclick="showPage('campaigns')">Manage â†’</button>
          </div>
          <div id="d-campaigns" style="color:var(--muted);font-size:13px">Loadingâ€¦</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ¢ Branch Activity</div>
            <button class="btn btn-secondary btn-sm" onclick="showPage('branches')">View All â†’</button>
          </div>
          <div id="d-branches" style="color:var(--muted);font-size:13px">Loadingâ€¦</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“Š Today at a Glance</div>
          <span id="glance-time" style="font-size:12px;color:var(--muted)"></span>
        </div>
        <div id="d-glance" style="color:var(--muted);font-size:13px">Loading dataâ€¦</div>
      </div>
    </div>

    <!-- â•â•â• CAMPAIGNS â•â•â• -->
    <div id="page-campaigns" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px">Campaign Management</div>
          <div style="font-size:13px;color:var(--muted);margin-top:3px">Create and manage reporting campaigns</div>
        </div>
        <button class="btn btn-primary" onclick="openCampModal()">ï¼‹ New Campaign</button>
      </div>
      <div id="campaignsList" style="color:var(--muted)">Loadingâ€¦</div>
    </div>

    <!-- â•â•â• BANNERS â•â•â• -->
    <div id="page-banners" style="display:none">
      <div style="margin-bottom:20px">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;margin-bottom:4px">Banner Images</div>
        <div style="font-size:13px;color:var(--muted)">Upload campaign banner images. They will auto-scroll in the branch portal.</div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“¤ Upload New Banner</div></div>
        <div class="upload-zone" onclick="document.getElementById('bannerFile').click()">
          <input type="file" id="bannerFile" accept="image/*" multiple onchange="handleBannerUpload(event)">
          <div style="font-size:32px;margin-bottom:10px">ğŸ–¼ï¸</div>
          <div style="font-size:14px;font-weight:600;margin-bottom:4px">Click to upload banner images</div>
          <div style="font-size:12px;color:var(--muted)">JPG, PNG, GIF â€” max 500KB each (stored as base64 in Google Sheets)</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ–¼ï¸ Current Banners (<span id="bannerCount">0</span>)</div>
          <button class="btn btn-secondary btn-sm" onclick="saveBannersToServer()">ğŸ’¾ Save to Server</button>
        </div>
        <div id="bannerGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px">
          <div style="color:var(--muted);font-size:13px">No banners uploaded yet.</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• REPORTS â•â•â• -->
    <div id="page-reports" style="display:none">
      <div style="display:flex;align-items:flex-end;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <div><div class="form-label">From Date</div><input type="date" id="rFrom" style="width:155px"></div>
        <div><div class="form-label">To Date</div><input type="date" id="rTo" style="width:155px"></div>
        <div><div class="form-label">Campaign</div><select id="rCamp" style="width:210px"><option value="">All Campaigns</option></select></div>
        <button class="btn btn-primary" onclick="loadReport()">ğŸ“Š Load Report</button>
      </div>
      <div class="export-bar" id="exportBar" style="display:none">
        <span class="lbl">Export:</span>
        <button class="btn btn-secondary btn-sm" onclick="exportExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-secondary btn-sm" onclick="exportPDF()">ğŸ“„ PDF</button>
        <button class="btn btn-secondary btn-sm" onclick="exportPNG()">ğŸ–¼ï¸ PNG</button>
      </div>
      <div class="table-wrap" id="reportWrap">
        <table id="reportTable">
          <thead><tr><th>Select a date range above and click Load Report</th></tr></thead>
          <tbody></tbody><tfoot></tfoot>
        </table>
      </div>
    </div>

    <!-- â•â•â• BRANCH ACTIVITY â•â•â• -->
    <div id="page-branches" style="display:none">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;flex:1">Branch Activity Monitor</div>
        <input type="date" id="bDate" style="width:165px" onchange="loadBranchActivity()">
        <button class="btn btn-secondary btn-sm" onclick="loadBranchActivity()">ğŸ”„ Refresh</button>
        <button class="btn btn-secondary btn-sm" onclick="exportBranchPNG()">ğŸ–¼ï¸ Save PNG</button>
      </div>
      <div style="display:flex;gap:20px;margin-bottom:14px;font-size:13px;flex-wrap:wrap">
        <span style="display:flex;align-items:center;gap:6px"><span class="dot dot-green"></span>Visited portal today</span>
        <span style="display:flex;align-items:center;gap:6px"><span class="dot dot-red"></span>Not visited yet</span>
        <span style="font-size:13px;color:var(--muted)" id="ba-summary"></span>
      </div>
      <div class="branch-grid" id="branchGrid" style="color:var(--muted)">Loadingâ€¦</div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div id="page-settings" style="display:none">
      <div class="grid-2">
        <div class="card">
          <div class="card-title" style="margin-bottom:16px">ğŸ¢ Manage Branches</div>
          <div style="max-height:360px;overflow-y:auto;margin-bottom:14px" id="branchListEl"></div>
          <div style="display:flex;gap:8px">
            <input type="text" id="newBranchInp" placeholder="Branch name (auto-uppercased)">
            <button class="btn btn-primary" onclick="addBranch()">Add</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:16px">ğŸ”— Portal URLs</div>
          <div class="form-group">
            <div class="form-label">Branch Portal (share with branches)</div>
            <input type="text" id="urlBranch" readonly onclick="this.select()" style="font-size:12px;cursor:pointer">
          </div>
          <div class="form-group">
            <div class="form-label">Admin Panel (keep confidential)</div>
            <input type="text" id="urlAdmin" readonly onclick="this.select()" style="font-size:12px;cursor:pointer">
          </div>
          <p style="font-size:12px;color:var(--muted)">Click a URL to select, then Ctrl+C to copy.</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Campaign Modal -->
<div class="modal-overlay" id="campModal">
  <div class="modal">
    <div class="modal-title">ğŸ¯ Create New Campaign</div>
    <div class="form-group"><div class="form-label">Campaign Name *</div>
      <input type="text" id="cName" placeholder="e.g. CYCLING WITH CMC"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div class="form-group"><div class="form-label">Start Date *</div><input type="date" id="cStart"></div>
      <div class="form-group"><div class="form-label">End Date (blank = ongoing)</div><input type="date" id="cEnd"></div>
    </div>
    <div class="form-group"><div class="form-label">Schedule</div>
      <select id="cSched">
        <option value="daily">Every Day</option>
        <option value="weekdays">Weekdays Only (Monâ€“Fri)</option>
        <option value="monday">Every Monday</option><option value="tuesday">Every Tuesday</option>
        <option value="wednesday">Every Wednesday</option><option value="thursday">Every Thursday</option>
        <option value="friday">Every Friday</option><option value="saturday">Every Saturday</option>
        <option value="sunday">Every Sunday</option>
      </select></div>
    <hr class="divider">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px">Parameters</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px">Each parameter = named group with columns (Number, Amountâ€¦)</div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="addParamGroup()">ï¼‹ Add Parameter</button>
    </div>
    <div id="paramGroups"></div>
    <div id="saveStatus" style="font-size:12px;color:var(--muted);margin-top:10px;min-height:16px"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCampModal()">Cancel</button>
      <button class="btn btn-primary" id="saveCampBtn" onclick="saveCampaign()">Save Campaign</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"><div class="spinner"></div><div style="font-size:14px;color:var(--muted)">Processingâ€¦</div></div>
<div class="toast" id="toast"><span id="toastIcon"></span>&nbsp;<span id="toastMsg"></span></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¼ PASTE YOUR APPS SCRIPT WEB APP URL HERE
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwN9X7-c4TwpZLf36_ZOhhkSLCNZRkUQTKigvTYLOg426ZuuOBYZLoGYdJx0rB2wJTbaw/exec';
// â–²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TODAY    = new Date();
const DATE_KEY = TODAY.toISOString().split('T')[0];
const CFG_OK   = SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';

let campaigns = [];
let branches  = ['MALAPPURAM','THIRUNAVAYA','KOTTAKKAL','OTHUKKUNGAL','PUTHANATHANI','POTHUKKALLU','PULAMANTHOLE','VALANCHERRY','PALAPATTY','PERINTHALMANNA','POOKKOTTUMPADAM','CALICUT ROAD PERINTHALMANNA','KARINKALLATHANI','NILAMBUR TOWN','PBB TIRUR','EDARICODE','MALAPPURAM CIVIL STATION','PULPARAMBA','KARUVARAKUNDU','NRI TIRUR','MANIMOOLY','WANDOOR','TIRUR','PANG SOUTH PANG','MANJERI TOWN','ANGADIPURAM','EDAPPAL TOWN','CHUNGATHARA','PONNANI','EDAKKARA','MAKKARAPARAMBA','PANDIKKAD','CHANGARAMKULAM','B P ANGADI','KUTTIPURAM','CHAMRAVATTOM JUNCTION PONNANI','KALPAKANCHERY','TIRUR TOWN','MANKADA','MANJERI','ELAMKULAM','CHANDAKKUNDU','MELATTUR','VENNIYOOR','PRAVASI SEVA KOTTAKKAL','MALAPPURAM TOWN BRANCH'];
let banners   = [];
let lastReportData = null;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('topDate').textContent =
  TODAY.toLocaleDateString('en-IN',{weekday:'short',year:'numeric',month:'short',day:'numeric'});
document.getElementById('rFrom').value = DATE_KEY;
document.getElementById('rTo').value   = DATE_KEY;
document.getElementById('bDate').value = DATE_KEY;
document.getElementById('urlBranch').value = location.href.replace(/admin\.html.*/,'index.html');
document.getElementById('urlAdmin').value  = location.href;

if (!CFG_OK) {
  document.getElementById('configAlert').innerHTML =
    `<div class="warn-box">âš ï¸ <strong>Script URL not set.</strong> Replace <code>YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE</code> in admin.html with your deployed Apps Script URL.<br>Running in <strong>demo mode</strong>.</div>`;
  campaigns = [{id:'demo1',name:'CYCLING WITH CMC',startDate:DATE_KEY,endDate:'2025-12-31',schedule:'daily',active:true,
    parameters:[{paramName:'PAI',columns:['Number','Amount']},{paramName:'PAI AUTORENEWAL',columns:['Number']},{paramName:'PAI NON-AUTORENEWAL',columns:['Number']}]}];
  refreshAll();
} else {
  document.getElementById('configAlert').innerHTML =
    `<div class="info-box" id="connectingBox">ğŸ”„ Connecting to Google Sheetsâ€¦
      <button class="btn btn-secondary btn-sm" style="margin-left:12px" onclick="pingServer()">ğŸ” Test</button></div>`;
  loadAdminData();
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAdminData() {
  showOverlay(true);
  try {
    const data = await apiCall({action:'adminData', date:DATE_KEY});
    if (data.campaigns) campaigns = data.campaigns;
    if (data.branches)  branches  = data.branches;
    if (data.totalReports !== undefined) document.getElementById('s-reports').textContent = data.totalReports;
    if (data.activity) {
      const v = new Set(data.activity.visited||[]);
      document.getElementById('s-branches').textContent = v.size;
      document.getElementById('s-brSub').textContent    = `of ${branches.length} visited today`;
      const pct = branches.length ? Math.round(v.size/branches.length*100) : 0;
      document.getElementById('s-brProg').style.width   = pct+'%';
      renderDashBranches(v);
    }
    // Load banners
    try {
      const bd = await apiCall({action:'getBanners'});
      if (bd.banners) { banners = bd.banners; renderBannerGrid(); }
    } catch(e){}
    document.getElementById('configAlert').innerHTML =
      `<div class="ok-box"><span style="font-size:13px;color:var(--success)">âœ… Connected to Google Sheets</span>
        <button class="btn btn-secondary btn-sm" onclick="pingServer()">ğŸ” Ping</button></div>`;
  } catch(e) { showDiagnosticError(e.message); }
  showOverlay(false);
  refreshAll();
}

async function pingServer() {
  try {
    const d = await apiCall({action:'ping'});
    toast(`âœ… Connected â€” Sheet: ${d.sheet}`, 'success');
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

function showDiagnosticError(msg) {
  const isSheet = msg.includes('openById')||msg.includes('SpreadsheetApp')||msg.includes('getActiveSpreadsheet');
  let fix = msg;
  if (isSheet) fix = `Script not bound to spreadsheet. Open your Sheet â†’ Extensions â†’ Apps Script â†’ paste code â†’ run setup() â†’ re-deploy.`;
  else if (msg.includes('Got HTML')) fix = `Deployment not public. In Apps Script: Deploy â†’ Manage â†’ Edit â†’ set "Anyone" access â†’ New Version.`;
  document.getElementById('configAlert').innerHTML =
    `<div class="warn-box">âŒ <strong>Connection failed:</strong> ${fix}
      <div style="margin-top:10px;font-family:monospace;font-size:11px;background:rgba(0,0,0,.3);padding:8px;border-radius:6px;word-break:break-all">${msg}</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="pingServer()">ğŸ” Diagnostic</button>
        <button class="btn btn-secondary btn-sm" onclick="loadAdminData()">â†º Retry</button>
      </div></div>`;
}

function refreshAll() {
  renderDashboard();
  renderCampaignsList();
  renderBranchListEl();
  renderReportFilter();
  document.getElementById('s-total').textContent = campaigns.length;
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const active = campaigns.filter(isTodayActive);
  document.getElementById('s-camps').textContent = active.length;
  document.getElementById('glance-time').textContent = 'As of '+new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

  document.getElementById('d-campaigns').innerHTML = active.length
    ? active.map(c=>`
        <div class="camp-row">
          <div style="flex:1">
            <div class="camp-name">${c.name}</div>
            <div class="camp-meta">
              <span style="color:var(--accent)">${c.schedule}</span> &nbsp;Â·&nbsp;
              ${c.startDate||'â€”'} â†’ ${c.endDate||'ongoing'}<br>
              ${(c.parameters||[]).map(p=>`<span style="color:var(--cyan);font-weight:600">${p.paramName}</span> [${(p.columns||[]).join(', ')}]`).join(' &nbsp;Â·&nbsp; ')}
            </div>
          </div>
          <span class="badge badge-active">â— Active</span>
        </div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:8px 0">No active campaigns today</div>';

  // Glance panel
  document.getElementById('d-glance').innerHTML = campaigns.length
    ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">
        ${campaigns.map(c=>`
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
            <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div>
            <div style="font-size:11px;color:var(--muted)">${c.startDate||'â€”'} â†’ ${c.endDate||'ongoing'}</div>
            <div style="margin-top:8px"><span class="badge ${isTodayActive(c)?'badge-active':'badge-inactive'}">${isTodayActive(c)?'â— Active':'Inactive'}</span></div>
          </div>`).join('')}
      </div>`
    : '<div style="color:var(--muted);font-size:13px">No campaigns created yet</div>';
}

function renderDashBranches(visitedSet) {
  const visiting = branches.filter(b=>visitedSet.has(b));
  document.getElementById('d-branches').innerHTML = visiting.length
    ? `<div class="timeline">${visiting.slice(0,8).map(b=>`
        <div class="tl-item"><span class="tl-dot"></span><span class="tl-name">${b}</span><span class="tl-time">Today</span></div>`
      ).join('')}${visiting.length>8?`<div style="font-size:12px;color:var(--muted);padding:6px 0">+${visiting.length-8} more branches</div>`:''}</div>`
    : '<div style="color:var(--muted);font-size:13px;padding:8px 0">No branches have visited today</div>';
}

function isTodayActive(c) {
  if (!c.active) return false;
  if (c.endDate   && c.endDate   < DATE_KEY) return false;
  if (c.startDate && c.startDate > DATE_KEY) return false;
  const dow=TODAY.getDay(), s=(c.schedule||'daily').toLowerCase();
  if (s==='daily') return true;
  if (s==='weekdays') return dow>=1&&dow<=5;
  if (s==='weekends') return dow===0||dow===6;
  return ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][dow]===s;
}

// â”€â”€ CAMPAIGNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCampaignsList() {
  const el = document.getElementById('campaignsList');
  if (!campaigns.length) { el.innerHTML='<div style="color:var(--muted);padding:20px 0">No campaigns yet. Click + New Campaign.</div>'; return; }
  el.innerHTML = campaigns.map(c=>`
    <div class="camp-row">
      <div style="flex:1;min-width:0">
        <div class="camp-name">${c.name}</div>
        <div class="camp-meta">
          <strong style="color:var(--text2)">${c.schedule}</strong> &nbsp;Â·&nbsp;
          ${c.startDate||'â€”'} â†’ ${c.endDate||'ongoing'}<br>
          ${(c.parameters||[]).map(p=>`<span style="color:var(--accent)">${p.paramName}</span>: ${(p.columns||[]).join(', ')}`).join(' &nbsp;|&nbsp; ')}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;margin-top:4px">
        <span class="badge ${isTodayActive(c)?'badge-active':'badge-inactive'}">${isTodayActive(c)?'â— Active':'Inactive'}</span>
        <button class="btn btn-danger btn-sm" onclick="deleteCampaign('${c.id}')">âœ•</button>
      </div>
    </div>`).join('');
}

// â”€â”€ CAMPAIGN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pgCount=0;
function openCampModal() {
  pgCount=0;
  ['cName','cEnd'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cStart').value='';
  document.getElementById('cSched').value='daily';
  document.getElementById('paramGroups').innerHTML='';
  document.getElementById('saveStatus').textContent='';
  addParamGroup('PAI',['Number','Amount']);
  document.getElementById('campModal').classList.add('show');
}
function closeCampModal(){ document.getElementById('campModal').classList.remove('show'); }

function addParamGroup(name,cols){
  const id=pgCount++;
  const div=document.createElement('div');
  div.className='param-block'; div.id='pg_'+id;
  div.innerHTML=`
    <div class="param-header">
      <input type="text" id="pgName_${id}" placeholder="Parameter name e.g. PAI" value="${name||''}">
      <button class="btn btn-danger btn-sm" onclick="this.closest('.param-block').remove()">âœ•</button>
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px">Columns:</div>
    <div class="col-pills" id="pills_${id}"></div>
    <div class="col-add-row">
      <input type="text" id="colInp_${id}" placeholder="Column e.g. Number, Amount" onkeydown="if(event.key==='Enter'){addCol(${id});event.preventDefault()}">
      <button class="btn btn-secondary btn-sm" onclick="addCol(${id})">ï¼‹</button>
    </div>`;
  document.getElementById('paramGroups').appendChild(div);
  (cols||['Number']).forEach(c=>insertPill(id,c));
}

function insertPill(pgId,col){
  const el=document.getElementById('pills_'+pgId); if(!el) return;
  if(Array.from(el.querySelectorAll('.col-pill')).some(p=>p.dataset.col===col)) return;
  const span=document.createElement('span');
  span.className='col-pill'; span.dataset.col=col;
  span.innerHTML=col+' <button onclick="this.parentElement.remove()">Ã—</button>';
  el.appendChild(span);
}
function addCol(id){ const inp=document.getElementById('colInp_'+id); const v=inp.value.trim(); if(v){insertPill(id,v);inp.value='';} }

function getParamGroups(){
  return Array.from(document.querySelectorAll('.param-block')).map(block=>{
    const id=block.id.replace('pg_','');
    const name=document.getElementById('pgName_'+id)?.value.trim();
    if(!name) return null;
    const columns=Array.from(block.querySelectorAll('.col-pill')).map(p=>p.dataset.col).filter(Boolean);
    if(!columns.length) columns.push('Number');
    return {paramName:name, columns};
  }).filter(Boolean);
}

async function saveCampaign(){
  const name=document.getElementById('cName').value.trim();
  const start=document.getElementById('cStart').value;
  if(!name){toast('Enter campaign name','error');return;}
  if(!start){toast('Enter start date','error');return;}
  const params=getParamGroups();
  if(!params.length){toast('Add at least one parameter','error');return;}
  const campaign={id:String(Date.now()),name,active:true,startDate:start,
    endDate:document.getElementById('cEnd').value,
    schedule:document.getElementById('cSched').value, parameters:params};
  document.getElementById('saveCampBtn').disabled=true;
  document.getElementById('saveStatus').textContent='Savingâ€¦';
  showOverlay(true);
  try {
    if(CFG_OK){ const res=await apiCall({action:'saveCampaign'},campaign); campaigns.push(res.campaign||campaign); }
    else campaigns.push(campaign);
    refreshAll(); closeCampModal();
    toast(`Campaign "${name}" created!`,'success');
  } catch(e){ document.getElementById('saveStatus').textContent='Error: '+e.message; toast('Save failed: '+e.message,'error'); }
  showOverlay(false); document.getElementById('saveCampBtn').disabled=false;
}

async function deleteCampaign(id){
  if(!confirm('Delete this campaign?')) return;
  if(CFG_OK){ try{await apiCall({action:'deleteCampaign',id});}catch(e){toast('Delete failed','error');return;} }
  campaigns=campaigns.filter(c=>String(c.id)!==String(id));
  refreshAll(); toast('Deleted','success');
}

// â”€â”€ BANNER MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleBannerUpload(evt) {
  const files = Array.from(evt.target.files);
  let loaded = 0;
  files.forEach(file => {
    if (file.size > 600000) { toast(`${file.name} too large (max 500KB)`,'warning'); loaded++; checkDone(); return; }
    const reader = new FileReader();
    reader.onload = e => {
      banners.push({ id: Date.now()+Math.random(), src: e.target.result, caption: file.name.replace(/\.[^.]+$/,''), order: banners.length });
      loaded++;
      checkDone();
    };
    reader.readAsDataURL(file);
  });
  function checkDone() { if (loaded===files.length) { renderBannerGrid(); toast(`${files.length} image(s) added. Click "Save to Server".`,'success'); } }
  evt.target.value = '';
}

function renderBannerGrid() {
  const el = document.getElementById('bannerGrid');
  document.getElementById('bannerCount').textContent = banners.length;
  if (!banners.length) { el.innerHTML='<div style="color:var(--muted);font-size:13px">No banners uploaded yet.</div>'; return; }
  el.innerHTML = banners.map((b,i)=>`
    <div class="banner-card">
      <img src="${b.src}" class="banner-preview" alt="banner">
      <button class="del-btn" onclick="removeBanner(${i})">âœ•</button>
      <div class="banner-info">
        <input type="text" value="${b.caption||''}" placeholder="Caption (optional)"
          oninput="banners[${i}].caption=this.value" style="font-size:12px;padding:6px 10px">
        <div class="banner-caption" style="margin-top:4px;font-size:11px;color:var(--muted)">Image ${i+1} of ${banners.length}</div>
      </div>
    </div>`).join('');
}

function removeBanner(i){ banners.splice(i,1); renderBannerGrid(); }

async function saveBannersToServer() {
  if(!CFG_OK){ toast('Demo mode â€” not saved','warning'); return; }
  showOverlay(true);
  try {
    await apiCall({action:'saveBanners'}, banners);
    toast('Banners saved to server âœ…','success');
  } catch(e){ toast('Save failed: '+e.message,'error'); }
  showOverlay(false);
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReportFilter(){
  const sel=document.getElementById('rCamp'), cur=sel.value;
  sel.innerHTML='<option value="">All Campaigns</option>'+
    campaigns.map(c=>`<option value="${c.name}"${c.name===cur?' selected':''}>${c.name}</option>`).join('');
}

async function loadReport(){
  const from=document.getElementById('rFrom').value;
  const to=document.getElementById('rTo').value;
  const camp=document.getElementById('rCamp').value;
  if(!from||!to){toast('Select date range','warning');return;}
  showOverlay(true);
  try {
    let data;
    if(CFG_OK){
      data=await apiCall({action:'getReport',from,to,campaign:camp});
    } else {
      data={rows:branches.map(b=>({branch:b})),campaigns};
    }
    lastReportData={data,from,to,camp};
    renderTable(data,camp,from,to);
    document.getElementById('exportBar').style.display='flex';
  } catch(e){ toast('Report failed: '+e.message,'error'); }
  showOverlay(false);
}

function renderTable(data,campFilter,from,to){
  const table=document.getElementById('reportTable');
  const filtCamps=campFilter?campaigns.filter(c=>c.name===campFilter):campaigns;
  if(!filtCamps.length){
    table.innerHTML='<thead><tr><th>No campaigns to display</th></tr></thead><tbody></tbody><tfoot></tfoot>';
    return;
  }
  // Build flat column list
  const cols=[{label:'Branch',key:'branch',camp:null,param:null}];
  filtCamps.forEach(c=>{
    (c.parameters||[]).forEach(p=>{
      (p.columns||[]).forEach(col=>{
        cols.push({label:col,campName:c.name,paramName:p.paramName,key:p.paramName+'__'+col});
      });
    });
  });

  const totals=new Array(cols.length-1).fill(0);
  const rowHtml=branches.map(b=>{
    const rd=(data.rows||[]).find(r=>r.branch===b)||{};
    const cells=cols.slice(1).map((col,i)=>{
      const v=Number(((rd[col.campName]||{})[col.key])||0);
      totals[i]+=v;
      return v;
    });
    return `<tr><td><strong>${b}</strong></td>${cells.map(v=>`<td>${v||'â€”'}</td>`).join('')}</tr>`;
  }).join('');

  // Multi-level header
  let thHtml=`<th rowspan="2" style="vertical-align:bottom">Branch</th>`;
  // Camp span headers
  filtCamps.forEach(c=>{
    const span=(c.parameters||[]).reduce((s,p)=>s+(p.columns||[]).length,0);
    thHtml+=`<th colspan="${span}" style="text-align:center;color:var(--accent);border-bottom:1px solid var(--border)">${c.name}</th>`;
  });
  let th2='';
  filtCamps.forEach(c=>{
    (c.parameters||[]).forEach(p=>{
      (p.columns||[]).forEach(col=>{
        th2+=`<th style="white-space:nowrap"><span style="color:var(--cyan);display:block;font-size:9px">${p.paramName}</span>${col}</th>`;
      });
    });
  });

  table.innerHTML=`
    <thead>
      <tr>${thHtml}</tr>
      <tr>${th2}</tr>
    </thead>
    <tbody>${rowHtml}</tbody>
    <tfoot><tr>
      <td>TOTAL</td>
      ${totals.map(t=>`<td>${t||0}</td>`).join('')}
    </tr></tfoot>`;
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportExcel(){
  if(!lastReportData){toast('Load a report first','warning');return;}
  const {data,camp,from,to}=lastReportData;
  const filtCamps=camp?campaigns.filter(c=>c.name===camp):campaigns;
  const headers=['Branch'];
  filtCamps.forEach(c=>(c.parameters||[]).forEach(p=>(p.columns||[]).forEach(col=>headers.push(`${c.name} | ${p.paramName} | ${col}`))));
  const rows=branches.map(b=>{
    const rd=(data.rows||[]).find(r=>r.branch===b)||{};
    const cells=filtCamps.flatMap(c=>(c.parameters||[]).flatMap(p=>(p.columns||[]).map(col=>Number(((rd[c.name]||{})[p.paramName+'__'+col])||0))));
    return [b,...cells];
  });
  const totals=['TOTAL',...(()=>{const t=new Array(headers.length-1).fill(0);rows.forEach(r=>r.slice(1).forEach((v,i)=>t[i]+=Number(v)||0));return t;})()];
  const ws=XLSX.utils.aoa_to_sheet([headers,...rows,totals]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Report');
  XLSX.writeFile(wb,`Report_${from}_to_${to}.xlsx`);
  toast('Excel downloaded','success');
}

async function exportPDF(){
  if(!lastReportData){toast('Load a report first','warning');return;}
  showOverlay(true);
  try {
    const {jsPDF}=window.jspdf;
    const canvas=await html2canvas(document.getElementById('reportWrap'),{backgroundColor:'#0d1526',scale:1.5});
    const img=canvas.toDataURL('image/png');
    const pdf=new jsPDF({orientation:'landscape',unit:'mm',format:'a3'});
    const w=pdf.internal.pageSize.getWidth(), h=canvas.height*(w/canvas.width);
    pdf.addImage(img,'PNG',0,0,w,Math.min(h,pdf.internal.pageSize.getHeight()));
    pdf.save(`Report_${lastReportData.from}_to_${lastReportData.to}.pdf`);
    toast('PDF downloaded','success');
  } catch(e){ toast('PDF error: '+e.message,'error'); }
  showOverlay(false);
}

async function exportPNG(){
  if(!lastReportData){toast('Load a report first','warning');return;}
  showOverlay(true);
  try {
    const canvas=await html2canvas(document.getElementById('reportWrap'),{backgroundColor:'#0d1526',scale:2});
    const a=document.createElement('a'); a.href=canvas.toDataURL(); a.download=`Report_${lastReportData.from}_${lastReportData.to}.png`; a.click();
    toast('PNG downloaded','success');
  } catch(e){ toast('PNG error: '+e.message,'error'); }
  showOverlay(false);
}

async function exportBranchPNG(){
  showOverlay(true);
  try {
    const canvas=await html2canvas(document.getElementById('branchGrid'),{backgroundColor:'#0d1526',scale:2});
    const a=document.createElement('a'); a.href=canvas.toDataURL(); a.download=`BranchActivity_${document.getElementById('bDate').value}.png`; a.click();
    toast('PNG saved','success');
  } catch(e){ toast('Error: '+e.message,'error'); }
  showOverlay(false);
}

// â”€â”€ BRANCH ACTIVITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBranchActivity(){
  const date=document.getElementById('bDate').value||DATE_KEY;
  let visited=new Set();
  if(CFG_OK){
    try{ const d=await apiCall({action:'getBranchActivity',date}); visited=new Set(d.visited||[]); }
    catch(e){}
  }
  const pct=branches.length?Math.round(visited.size/branches.length*100):0;
  document.getElementById('s-branches').textContent=visited.size;
  document.getElementById('s-brProg').style.width=pct+'%';
  document.getElementById('ba-summary').textContent=`${visited.size} of ${branches.length} branches (${pct}%)`;
  document.getElementById('branchGrid').innerHTML=branches.map(b=>`
    <div class="branch-tile">
      <span class="dot ${visited.has(b)?'dot-green':'dot-red'}"></span>
      <span>${b}</span>
    </div>`).join('');
  renderDashBranches(visited);
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBranchListEl(){
  document.getElementById('branchListEl').innerHTML=branches.map((b,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="flex:1;font-size:13px">${b}</span>
      <button class="btn btn-danger btn-sm" onclick="removeBranch(${i})">âœ•</button>
    </div>`).join('');
}
async function addBranch(){
  const v=document.getElementById('newBranchInp').value.trim().toUpperCase();
  if(!v){toast('Enter name','error');return;}
  if(branches.includes(v)){toast('Already exists','warning');return;}
  branches.push(v); renderBranchListEl();
  document.getElementById('newBranchInp').value='';
  if(CFG_OK) try{await apiCall({action:'updateBranches'},branches);}catch(e){}
  toast(`"${v}" added`,'success');
}
async function removeBranch(i){
  if(!confirm(`Remove "${branches[i]}"?`)) return;
  branches.splice(i,1); renderBranchListEl();
  if(CFG_OK) try{await apiCall({action:'updateBranches'},branches);}catch(e){}
}

// â”€â”€ PAGE NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PAGE_TITLES={dashboard:'Dashboard',campaigns:'Campaigns',banners:'Banner Images',
  reports:'Reports',branches:'Branch Activity',settings:'Settings'};
const PAGE_BREADS={dashboard:'Overview & Statistics',campaigns:'Manage & Create Campaigns',
  banners:'Upload images for branch portal carousel',reports:'View & Export Submission Data',
  branches:'Monitor who has visited today',settings:'System Configuration'};

function showPage(p){
  ['dashboard','campaigns','banners','reports','branches','settings'].forEach(n=>{
    document.getElementById('page-'+n).style.display=n===p?'block':'none';
    document.getElementById('nav-'+n).classList.toggle('active',n===p);
  });
  document.getElementById('pageTitle').textContent=PAGE_TITLES[p];
  document.getElementById('pageBread').textContent=PAGE_BREADS[p];
  if(p==='branches') loadBranchActivity();
  if(p==='reports')  renderReportFilter();
  document.getElementById('sidebar').classList.remove('open');
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiCall(params, payload){
  const qs=Object.entries(params).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(String(v))).join('&');
  let url=SCRIPT_URL+'?'+qs;
  if(payload!==undefined) url+='&payload='+encodeURIComponent(JSON.stringify(payload));
  let res;
  try{ res=await fetch(url,{redirect:'follow'}); }
  catch(e){ throw new Error('Network error: '+e.message); }
  const text=await res.text();
  if(text.trim().startsWith('<')) throw new Error('Got HTML â€” check deployment access is set to "Anyone"');
  let d;
  try{ d=JSON.parse(text); } catch(e){ throw new Error('Bad JSON: '+text.substring(0,80)); }
  if(d&&d.error) throw new Error(d.error);
  return d;
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOverlay(v){ document.getElementById('overlay').classList.toggle('show',v); }
function toast(msg,type='success'){
  const icons={success:'âœ…',error:'âŒ',warning:'âš ï¸'};
  const t=document.getElementById('toast');
  document.getElementById('toastMsg').textContent=msg;
  document.getElementById('toastIcon').textContent=icons[type]||'â„¹ï¸';
  t.className='toast '+type+' show';
  setTimeout(()=>t.classList.remove('show'),4500);
}
</script>
</body>
</html>
