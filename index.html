<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Campaign Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:       #f0f4f8;
  --white:    #ffffff;
  --surface:  #f8fafc;
  --border:   #e2e8f0;
  --border2:  #cbd5e1;

  --blue:     #2563eb;
  --blue-lt:  #eff6ff;
  --blue-dk:  #1d4ed8;
  --cyan:     #0891b2;
  --cyan-lt:  #ecfeff;
  --green:    #16a34a;
  --green-lt: #f0fdf4;
  --orange:   #ea580c;
  --orange-lt:#fff7ed;
  --red:      #dc2626;
  --red-lt:   #fef2f2;
  --amber:    #d97706;
  --amber-lt: #fffbeb;
  --purple:   #7c3aed;
  --purple-lt:#f5f3ff;

  --text:     #0f172a;
  --text2:    #475569;
  --muted:    #94a3b8;

  --radius:   14px;
  --radius-sm:9px;
  --shadow:   0 1px 4px rgba(0,0,0,.06), 0 4px 16px rgba(0,0,0,.06);
  --shadow-lg:0 8px 32px rgba(0,0,0,.12);
}

html { font-size: 16px; -webkit-text-size-adjust: 100%; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: var(--blue);
  padding: 0 16px;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 200;
  box-shadow: 0 2px 8px rgba(37,99,235,.3);
}
.h-logo {
  width: 34px; height: 34px; border-radius: 9px;
  background: rgba(255,255,255,.25);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 800; color: #fff; flex-shrink: 0;
}
.h-title { font-size: 16px; font-weight: 700; color: #fff; }
.h-sub   { font-size: 11px; color: rgba(255,255,255,.7); margin-top: 1px; }
.h-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.h-date  {
  background: rgba(255,255,255,.18);
  border-radius: 6px; padding: 4px 10px;
  font-size: 11px; font-weight: 600; color: #fff;
}
.h-refresh {
  background: rgba(255,255,255,.18); border: none;
  border-radius: 6px; padding: 6px 10px;
  font-size: 12px; font-weight: 600; color: #fff;
  cursor: pointer; transition: background .15s;
  font-family: inherit;
}
.h-refresh:active { background: rgba(255,255,255,.3); }

/* â”€â”€â”€ BANNER CAROUSEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.carousel-wrap {
  position: relative; overflow: hidden;
  background: #1e293b;
  display: none;  /* shown by JS when banners exist */
  height: 180px;
}
.c-track {
  display: flex; height: 100%;
  transition: transform .45s ease;
}
.c-slide {
  min-width: 100%; height: 100%;
  object-fit: cover; flex-shrink: 0; display: block;
}
.c-overlay {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,.55));
  padding: 28px 16px 10px;
}
.c-caption { font-size: 12px; font-weight: 600; color: #fff; }
.c-dots {
  position: absolute; top: 10px; right: 12px;
  display: flex; gap: 5px;
}
.c-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: rgba(255,255,255,.4); cursor: pointer; transition: all .25s;
}
.c-dot.on { background: #fff; width: 16px; border-radius: 3px; }

/* â”€â”€â”€ MAIN CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wrap { max-width: 540px; margin: 0 auto; padding: 16px 14px 40px; }

/* â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 12px;
  overflow: hidden;
}

/* â”€â”€â”€ BRANCH SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.branch-header {
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.branch-header-icon {
  width: 30px; height: 30px; border-radius: 8px;
  background: var(--blue-lt);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; flex-shrink: 0;
}
.branch-header-label { font-size: 13px; font-weight: 700; color: var(--text); }
.branch-header-sub   { font-size: 11px; color: var(--muted); }

/* The visible "selector" button */
.branch-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 13px 16px;
  cursor: pointer; user-select: none;
  transition: background .15s;
}
.branch-btn:active { background: var(--bg); }
.branch-btn-icon { font-size: 18px; flex-shrink: 0; }
.branch-btn-text { flex: 1; }
.branch-btn-name { font-size: 15px; font-weight: 600; color: var(--text); }
.branch-btn-hint { font-size: 12px; color: var(--muted); margin-top: 1px; }
.branch-btn-chevron {
  font-size: 12px; color: var(--muted);
  transition: transform .2s; flex-shrink: 0;
}
.branch-btn-chevron.open { transform: rotate(180deg); }

/* Confirmed state chip */
.branch-confirmed-bar {
  display: none;
  align-items: center; gap: 8px;
  padding: 10px 16px;
  background: var(--green-lt);
  border-top: 1px solid #bbf7d0;
}
.branch-confirmed-bar .bc-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green); flex-shrink: 0;
}
.branch-confirmed-bar .bc-name { font-size: 13px; font-weight: 700; color: var(--green); flex: 1; }
.branch-confirmed-bar .bc-change {
  font-size: 11px; color: var(--muted); cursor: pointer; font-weight: 600;
  padding: 3px 8px; border-radius: 20px; background: rgba(0,0,0,.05);
}
.branch-confirmed-bar .bc-change:hover { color: var(--blue); }

/* Dropdown panel */
.branch-dropdown-wrap {
  display: none;
  padding: 10px 14px 14px;
  border-top: 1px solid var(--border);
}
.branch-dropdown-wrap.open { display: block; }
.branch-search {
  width: 100%; border: 1.5px solid var(--border2);
  border-radius: var(--radius-sm); padding: 10px 14px;
  font-size: 14px; font-family: inherit; outline: none;
  color: var(--text); background: var(--surface);
  transition: border-color .2s;
  -webkit-appearance: none; appearance: none;
}
.branch-search:focus { border-color: var(--blue); background: var(--white); }
.branch-list {
  margin-top: 8px; max-height: 220px; overflow-y: auto;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--white);
}
.bl-item {
  padding: 11px 14px; font-size: 14px; font-weight: 500;
  cursor: pointer; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px; transition: background .12s;
}
.bl-item:last-child { border-bottom: none; }
.bl-item:hover, .bl-item.sel { background: var(--blue-lt); color: var(--blue); }
.bl-item .bi { width: 26px; height: 26px; border-radius: 6px;
  background: var(--blue-lt); color: var(--blue);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800; flex-shrink: 0; }
.bl-item.sel .bi { background: var(--blue); color: #fff; }
.bl-item mark { background: none; color: var(--cyan); font-weight: 700; }
.bl-empty { padding: 16px; text-align: center; font-size: 13px; color: var(--muted); }

/* â”€â”€â”€ DATE STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-strip {
  display: none;
  align-items: center; gap: 10px;
  padding: 11px 16px;
}
.date-strip-dot {
  width: 9px; height: 9px; border-radius: 50%;
  background: var(--green); flex-shrink: 0;
  box-shadow: 0 0 0 3px rgba(22,163,74,.15);
  animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.5} }
.date-strip-main { font-size: 14px; font-weight: 600; }
.date-strip-sub  { font-size: 11px; color: var(--muted); margin-top: 1px; }

/* â”€â”€â”€ CAMPAIGN CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.camp-card {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 12px;
  overflow: hidden;
}
.camp-card-header {
  background: linear-gradient(135deg, #1e3a5f, #1e4476);
  padding: 14px 16px;
  display: flex; align-items: center; gap: 10px;
}
.camp-status-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #4ade80; flex-shrink: 0;
  box-shadow: 0 0 0 3px rgba(74,222,128,.25);
  animation: blink 2s infinite;
}
.camp-title {
  font-size: 15px; font-weight: 700; color: #fff; flex: 1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.camp-live-badge {
  background: rgba(74,222,128,.2); border: 1px solid rgba(74,222,128,.4);
  color: #4ade80; border-radius: 20px; padding: 2px 9px;
  font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: .8px;
  flex-shrink: 0;
}
.camp-body { padding: 16px; }

/* â”€â”€â”€ PARAMETER GROUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.param-group {
  margin-bottom: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.param-group:last-child { margin-bottom: 0; }
.param-group-header {
  background: var(--surface);
  padding: 8px 14px;
  font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--cyan); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 6px;
}
.param-group-header::before {
  content: ''; width: 3px; height: 12px;
  background: var(--cyan); border-radius: 2px; flex-shrink: 0;
}
.param-fields { padding: 12px; display: grid; gap: 10px; }

/* single column by default, 2-col when 2+ fields */
.param-fields.cols-1 { grid-template-columns: 1fr; }
.param-fields.cols-2 { grid-template-columns: 1fr 1fr; }
.param-fields.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

.field-wrap { display: flex; flex-direction: column; gap: 5px; }
.field-label {
  font-size: 11px; font-weight: 700; color: var(--text2);
  text-transform: uppercase; letter-spacing: .5px;
}
.field-input {
  width: 100%; padding: 12px 10px;
  border: 1.5px solid var(--border2);
  border-radius: var(--radius-sm);
  font-size: 18px; font-weight: 700;
  text-align: center; color: var(--text);
  background: var(--white); font-family: inherit;
  -webkit-appearance: none; appearance: none; outline: none;
  transition: border-color .18s, box-shadow .18s;
}
.field-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(37,99,235,.1);
}
.field-input::placeholder { color: var(--border2); font-weight: 400; }
.field-total {
  font-size: 11px; color: var(--amber);
  font-weight: 600; text-align: center;
  background: var(--amber-lt); border-radius: 5px; padding: 3px 6px;
  display: none;
}
.field-total.show { display: block; }

/* â”€â”€â”€ SUBMIT SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.submit-wrap {
  display: none;
  margin-top: 4px; margin-bottom: 32px;
}
.submit-btn {
  width: 100%; padding: 17px;
  border: none; border-radius: var(--radius);
  font-size: 16px; font-weight: 800; font-family: inherit;
  letter-spacing: .3px; cursor: pointer;
  background: linear-gradient(135deg, var(--blue), var(--cyan));
  color: #fff;
  box-shadow: 0 4px 20px rgba(37,99,235,.35);
  transition: all .2s;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(37,99,235,.4); }
.submit-btn:active { transform: translateY(0); }
.submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; box-shadow: none; }
.submit-hint {
  text-align: center; font-size: 12px; color: var(--muted);
  margin-top: 8px;
}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align: center; padding: 48px 20px; color: var(--muted);
}
.empty-state .es-icon { font-size: 52px; margin-bottom: 14px; display: block; }
.empty-state h3 { font-size: 16px; font-weight: 700; color: var(--text2); margin-bottom: 6px; }
.empty-state p  { font-size: 13px; color: var(--muted); line-height: 1.6; }

/* â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert {
  border-radius: var(--radius-sm);
  padding: 12px 14px; font-size: 13px;
  margin-bottom: 12px; line-height: 1.6;
}
.alert-warn { background: var(--amber-lt); border: 1px solid #fde68a; color: #92400e; }

/* â”€â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(15,23,42,.7);
  display: none; align-items: center; justify-content: center;
  z-index: 500; flex-direction: column; gap: 14px;
  backdrop-filter: blur(3px);
}
.overlay.on { display: flex; }
.spinner {
  width: 40px; height: 40px;
  border: 3px solid rgba(255,255,255,.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.overlay-msg { font-size: 13px; color: rgba(255,255,255,.7); font-weight: 500; }

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed; bottom: 20px; left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: #1e293b; color: #fff;
  border-radius: 10px; padding: 12px 20px;
  font-size: 13.5px; font-weight: 500;
  display: flex; align-items: center; gap: 8px;
  box-shadow: var(--shadow-lg); z-index: 1000;
  transition: transform .35s cubic-bezier(.34,1.56,.64,1);
  max-width: 90vw; min-width: 240px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.toast.on { transform: translateX(-50%) translateY(0); }
.toast.t-success { border-left: 3px solid var(--green); }
.toast.t-error   { border-left: 3px solid var(--red); }
.toast.t-warning { border-left: 3px solid var(--amber); }

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.branch-list::-webkit-scrollbar { width: 4px; }
.branch-list::-webkit-scrollbar-track { background: transparent; }
.branch-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="h-logo">C</div>
  <div>
    <div class="h-title">Campaign Portal</div>
    <div class="h-sub">Branch Reporting</div>
  </div>
  <div class="h-right">
    <div class="h-date" id="hDate"></div>
    <button class="h-refresh" id="refreshBtn" onclick="handleRefresh()">â†º</button>
  </div>
</header>

<!-- BANNER CAROUSEL -->
<div class="carousel-wrap" id="carouselWrap">
  <div class="c-track" id="cTrack"></div>
  <div class="c-overlay"><div class="c-caption" id="cCaption"></div></div>
  <div class="c-dots" id="cDots"></div>
</div>

<!-- MAIN -->
<div class="wrap">

  <!-- Demo mode warning -->
  <div class="alert alert-warn" id="cfgWarn" style="display:none">
    âš ï¸ <strong>Demo mode:</strong> Replace SCRIPT_URL with your Apps Script URL.
  </div>

  <!-- â”€â”€ BRANCH SELECTOR â”€â”€ -->
  <div class="card" id="branchCard">
    <div class="branch-header">
      <div class="branch-header-icon">ğŸ¢</div>
      <div>
        <div class="branch-header-label">Select Your Branch</div>
        <div class="branch-header-sub">Required before submitting</div>
      </div>
    </div>

    <!-- Selector button (visible when dropdown closed) -->
    <div class="branch-btn" id="branchBtn" onclick="toggleDropdown()">
      <span class="branch-btn-icon">ğŸ“</span>
      <div class="branch-btn-text">
        <div class="branch-btn-name" id="branchBtnName">Tap to select your branch</div>
        <div class="branch-btn-hint" id="branchBtnHint">46 branches available</div>
      </div>
      <span class="branch-btn-chevron" id="branchChevron">â–¼</span>
    </div>

    <!-- Dropdown -->
    <div class="branch-dropdown-wrap" id="branchDropWrap">
      <input
        type="text"
        class="branch-search"
        id="branchSearch"
        placeholder="ğŸ”  Search branch nameâ€¦"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        oninput="filterBranches(this.value)"
      >
      <div class="branch-list" id="branchList"></div>
    </div>

    <!-- Confirmed bar -->
    <div class="branch-confirmed-bar" id="branchConfirmedBar">
      <span class="bc-dot"></span>
      <span class="bc-name" id="bcName">â€”</span>
      <span class="bc-change" onclick="toggleDropdown()">Change â–¼</span>
    </div>
  </div>

  <!-- â”€â”€ DATE STRIP â”€â”€ -->
  <div class="card" id="dateStrip" style="display:none">
    <div class="date-strip" id="dateStripInner">
      <span class="date-strip-dot"></span>
      <div>
        <div class="date-strip-main" id="dateStripDate"></div>
        <div class="date-strip-sub">Enter today's figures for each campaign below</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CAMPAIGNS â”€â”€ -->
  <div id="campArea"></div>

  <!-- â”€â”€ SUBMIT â”€â”€ -->
  <div class="submit-wrap" id="submitWrap">
    <button class="submit-btn" id="submitBtn" onclick="doSubmit()">
      <span>ğŸ“¤</span>
      <span>Submit Report</span>
    </button>
    <div class="submit-hint">You can submit multiple times â€” values are added to today's total</div>
  </div>

</div><!-- /wrap -->

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <div class="overlay-msg" id="overlayMsg">Loadingâ€¦</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="tIcon"></span>
  <span id="tMsg"></span>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–¼ PASTE YOUR APPS SCRIPT URL HERE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwN9X7-c4TwpZLf36_ZOhhkSLCNZRkUQTKigvTYLOg426ZuuOBYZLoGYdJx0rB2wJTbaw/exec';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const FALLBACK_BRANCHES = [
  'MALAPPURAM','THIRUNAVAYA','KOTTAKKAL','OTHUKKUNGAL','PUTHANATHANI','POTHUKKALLU',
  'PULAMANTHOLE','VALANCHERRY','PALAPATTY','PERINTHALMANNA','POOKKOTTUMPADAM',
  'CALICUT ROAD PERINTHALMANNA','KARINKALLATHANI','NILAMBUR TOWN','PBB TIRUR',
  'EDARICODE','MALAPPURAM CIVIL STATION','PULPARAMBA','KARUVARAKUNDU','NRI TIRUR',
  'MANIMOOLY','WANDOOR','TIRUR','PANG SOUTH PANG','MANJERI TOWN','ANGADIPURAM',
  'EDAPPAL TOWN','CHUNGATHARA','PONNANI','EDAKKARA','MAKKARAPARAMBA','PANDIKKAD',
  'CHANGARAMKULAM','B P ANGADI','KUTTIPURAM','CHAMRAVATTOM JUNCTION PONNANI',
  'KALPAKANCHERY','TIRUR TOWN','MANKADA','MANJERI','ELAMKULAM','CHANDAKKUNDU',
  'MELATTUR','VENNIYOOR','PRAVASI SEVA KOTTAKKAL','MALAPPURAM TOWN BRANCH'
];

const TODAY    = new Date();
const DATE_KEY = TODAY.toISOString().split('T')[0];
const CFG_OK   = SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';

let selectedBranch  = '';
let activeCampaigns = [];
let todayTotals     = {};
let allBranches     = [...FALLBACK_BRANCHES];
let ddOpen          = false;

/* carousel state */
let slides = [], slideIdx = 0, slideTimer = null;

/* â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('hDate').textContent =
  TODAY.toLocaleDateString('en-IN', { day:'2-digit', month:'short' });
document.getElementById('dateStripDate').textContent =
  TODAY.toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

if (!CFG_OK) document.getElementById('cfgWarn').style.display = 'block';

/* restore saved branch and auto-load */
const savedBranch = localStorage.getItem('cpBranch');
if (savedBranch && FALLBACK_BRANCHES.includes(savedBranch)) {
  applyBranch(savedBranch, false);   /* update UI but don't open dropdown */
  loadCampaigns();                   /* auto-refresh on every page load   */
}

renderBranchList('');

/* â”€â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleDropdown() {
  ddOpen ? closeDropdown() : openDropdown();
}

function openDropdown() {
  ddOpen = true;
  document.getElementById('branchDropWrap').classList.add('open');
  document.getElementById('branchChevron').classList.add('open');
  /* hide confirmed bar while open */
  document.getElementById('branchConfirmedBar').style.display = 'none';
  /* clear & focus search */
  const s = document.getElementById('branchSearch');
  s.value = '';
  renderBranchList('');
  /* slight delay lets the DOM paint before focus (important on iOS) */
  setTimeout(() => s.focus(), 60);
}

function closeDropdown() {
  ddOpen = false;
  document.getElementById('branchDropWrap').classList.remove('open');
  document.getElementById('branchChevron').classList.remove('open');
  if (selectedBranch) {
    document.getElementById('branchConfirmedBar').style.display = 'flex';
  }
}

/* close on outside tap */
document.addEventListener('click', e => {
  if (ddOpen && !e.target.closest('#branchCard')) closeDropdown();
});

function filterBranches(q) {
  renderBranchList(q.trim().toLowerCase());
}

function renderBranchList(q) {
  const list  = document.getElementById('branchList');
  const items = q
    ? allBranches.filter(b => b.toLowerCase().includes(q))
    : allBranches;

  if (!items.length) {
    list.innerHTML = '<div class="bl-empty">No branches found</div>';
    return;
  }

  list.innerHTML = items.slice(0, 40).map(b => {
    const hl  = q ? b.replace(new RegExp(q, 'gi'), m => `<mark>${m}</mark>`) : b;
    const sel = b === selectedBranch;
    return `<div class="bl-item${sel?' sel':''}" onclick="pickBranch('${b.replace(/'/g,"\\'")}')">
      <span class="bi">${b[0]}</span>
      <span>${hl}</span>
    </div>`;
  }).join('');
}

function pickBranch(branch) {
  applyBranch(branch, true);
  closeDropdown();
  loadCampaigns();
}

function applyBranch(branch, save) {
  selectedBranch = branch;
  if (save) localStorage.setItem('cpBranch', branch);

  /* update selector button */
  document.getElementById('branchBtnName').textContent = branch;
  document.getElementById('branchBtnName').style.color = 'var(--blue)';
  document.getElementById('branchBtnHint').textContent = 'Tap to change branch';

  /* show confirmed bar */
  document.getElementById('bcName').textContent = branch;
  document.getElementById('branchConfirmedBar').style.display = 'flex';
}

function handleRefresh() {
  if (selectedBranch) loadCampaigns();
  else toast('Select your branch first', 'warning');
}

/* â”€â”€â”€ CAROUSEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initCarousel(images) {
  if (!images || !images.length) return;
  slides    = images;
  slideIdx  = 0;
  const wrap = document.getElementById('carouselWrap');
  wrap.style.display = 'block';
  document.getElementById('cTrack').innerHTML =
    images.map(img => `<img class="c-slide" src="${img.src}" alt="${img.caption||''}">`).join('');
  document.getElementById('cDots').innerHTML =
    images.map((_, i) => `<div class="c-dot${i===0?' on':''}" onclick="goSlide(${i})"></div>`).join('');
  goSlide(0);
  if (slideTimer) clearInterval(slideTimer);
  if (images.length > 1) slideTimer = setInterval(() => goSlide((slideIdx + 1) % images.length), 4200);
}

function goSlide(i) {
  slideIdx = i;
  document.getElementById('cTrack').style.transform = `translateX(-${i * 100}%)`;
  document.querySelectorAll('.c-dot').forEach((d, j) => d.classList.toggle('on', j === i));
  document.getElementById('cCaption').textContent = slides[i]?.caption || '';
}

/* â”€â”€â”€ LOAD CAMPAIGNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadCampaigns() {
  if (!selectedBranch) return;
  showOverlay(true, 'Loading campaignsâ€¦');
  try {
    if (CFG_OK) {
      const data      = await apiCall({ action:'getCampaigns', branch:selectedBranch, date:DATE_KEY });
      activeCampaigns = data.campaigns || [];
      todayTotals     = data.todayData  || {};
      if (data.banners  && data.banners.length)  initCarousel(data.banners);
      if (data.branches && data.branches.length) {
        allBranches = data.branches;
        renderBranchList('');
      }
      apiCall({ action:'logVisit', branch:selectedBranch, date:DATE_KEY }).catch(() => {});
    } else {
      activeCampaigns = [
        { name:'CYCLING WITH CMC', parameters:[
            { paramName:'PAI',                   columns:['Number','Amount'] },
            { paramName:'PAI AUTORENEWAL',        columns:['Number'] },
            { paramName:'PAI NON-AUTORENEWAL',    columns:['Number'] }
          ]},
        { name:'UTKARSH', parameters:[
            { paramName:'ACCOUNTS', columns:['Number','Amount'] }
          ]}
      ];
      todayTotals = {};
    }
    document.getElementById('dateStrip').style.display = 'block';
    renderCamps();
  } catch(e) {
    showOverlay(false);
    toast('Load failed: ' + e.message, 'error');
    document.getElementById('campArea').innerHTML =
      `<div class="card"><div class="empty-state">
        <span class="es-icon">âš ï¸</span>
        <h3>Connection Error</h3>
        <p>${e.message}</p>
      </div></div>`;
    document.getElementById('submitWrap').style.display = 'none';
    return;
  }
  showOverlay(false);
}

/* â”€â”€â”€ RENDER CAMPAIGNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCamps() {
  const area = document.getElementById('campArea');

  if (!activeCampaigns.length) {
    area.innerHTML =
      `<div class="card"><div class="empty-state">
        <span class="es-icon">ğŸ“‹</span>
        <h3>No Active Campaigns</h3>
        <p>No campaigns are scheduled for today.<br>Check back later.</p>
      </div></div>`;
    document.getElementById('submitWrap').style.display = 'none';
    return;
  }

  document.getElementById('submitWrap').style.display = 'block';

  area.innerHTML = activeCampaigns.map((c, ci) => {
    const ct     = todayTotals[c.name] || {};
    const pgHtml = (c.parameters || []).map((p, pi) => {
      const cols    = p.columns || ['Number'];
      const colsLen = cols.length;
      const gridCls = colsLen >= 3 ? 'cols-3' : colsLen === 2 ? 'cols-2' : 'cols-1';

      const fieldsHtml = cols.map((col, ki) => {
        const fid     = `f_${ci}_${pi}_${ki}`;
        const prev    = ct[p.paramName + '__' + col];
        const isAmt   = col.toLowerCase().includes('amount') || col.toLowerCase().includes('amt');
        const hasPrev = prev !== undefined && prev > 0;
        const prevTxt = isAmt
          ? 'â‚¹' + Number(prev).toLocaleString('en-IN')
          : String(prev);

        return `<div class="field-wrap">
          <label class="field-label" for="${fid}">${col}</label>
          <input
            class="field-input"
            type="number" id="${fid}"
            min="0" step="${isAmt ? '0.01' : '1'}"
            placeholder="0"
            inputmode="decimal"
          >
          <div class="field-total${hasPrev ? ' show' : ''}" id="ft_${fid}">
            Today: ${hasPrev ? prevTxt : '0'}
          </div>
        </div>`;
      }).join('');

      return `<div class="param-group">
        <div class="param-group-header">${p.paramName}</div>
        <div class="param-fields ${gridCls}">${fieldsHtml}</div>
      </div>`;
    }).join('');

    return `<div class="camp-card">
      <div class="camp-card-header">
        <span class="camp-status-dot"></span>
        <span class="camp-title">${c.name}</span>
        <span class="camp-live-badge">Live</span>
      </div>
      <div class="camp-body">${pgHtml}</div>
    </div>`;
  }).join('');
}

/* â”€â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doSubmit() {
  if (!selectedBranch) { toast('Select your branch first', 'warning'); return; }

  const campData = {};
  let   hasZero  = false;

  activeCampaigns.forEach((c, ci) => {
    campData[c.name] = {};
    (c.parameters || []).forEach((p, pi) => {
      (p.columns || ['Number']).forEach((col, ki) => {
        const el  = document.getElementById(`f_${ci}_${pi}_${ki}`);
        const val = parseFloat(el?.value) || 0;
        if (val === 0) hasZero = true;
        campData[c.name][p.paramName + '__' + col] = val;
      });
    });
  });

  if (hasZero && !confirm('âš ï¸ One or more fields are zero.\n\nSubmit anyway?')) return;

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  showOverlay(true, 'Submitting reportâ€¦');

  try {
    if (CFG_OK) {
      const res = await apiCall(
        { action:'submitReport' },
        { branch:selectedBranch, date:DATE_KEY, campaigns:campData }
      );
      if (!res.success) throw new Error(res.error || 'Submission failed');
      todayTotals = res.todayData || todayTotals;
    } else {
      await new Promise(r => setTimeout(r, 700));
      activeCampaigns.forEach(c => {
        if (!todayTotals[c.name]) todayTotals[c.name] = {};
        (c.parameters||[]).forEach(p =>
          (p.columns||[]).forEach(col => {
            const k = p.paramName + '__' + col;
            todayTotals[c.name][k] =
              (todayTotals[c.name][k] || 0) + (campData[c.name][k] || 0);
          })
        );
      });
    }
    /* clear inputs, re-render updated totals */
    activeCampaigns.forEach((c, ci) =>
      (c.parameters||[]).forEach((p, pi) =>
        (p.columns||[]).forEach((_, ki) => {
          const el = document.getElementById(`f_${ci}_${pi}_${ki}`);
          if (el) el.value = '';
        })
      )
    );
    renderCamps();
    toast('Report submitted! âœ…', 'success');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch(e) {
    toast('Submit failed: ' + e.message, 'error');
  }

  showOverlay(false);
  btn.disabled = false;
}

/* â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function apiCall(params, payload) {
  const qs = Object.entries(params)
    .map(([k,v]) => encodeURIComponent(k) + '=' + encodeURIComponent(String(v)))
    .join('&');
  let url = SCRIPT_URL + '?' + qs;
  if (payload !== undefined)
    url += '&payload=' + encodeURIComponent(JSON.stringify(payload));

  let res;
  try { res = await fetch(url, { redirect:'follow' }); }
  catch(e) { throw new Error('Network error: ' + e.message); }

  const text = await res.text();
  if (text.trim().startsWith('<'))
    throw new Error('Got HTML â€” check Apps Script deployment (access: Anyone)');

  let data;
  try { data = JSON.parse(text); }
  catch(e) { throw new Error('Bad response: ' + text.substring(0,80)); }

  if (data && data.error) throw new Error(data.error);
  return data;
}

/* â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showOverlay(v, msg) {
  document.getElementById('overlay').classList.toggle('on', v);
  if (msg) document.getElementById('overlayMsg').textContent = msg;
}

let toastTimer;
function toast(msg, type = 'success') {
  const icons = { success:'âœ…', error:'âŒ', warning:'âš ï¸' };
  const el = document.getElementById('toast');
  document.getElementById('tIcon').textContent = icons[type] || 'â„¹ï¸';
  document.getElementById('tMsg').textContent  = msg;
  el.className = `toast on t-${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('on'), 3800);
}
</script>
</body>
</html>
